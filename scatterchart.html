<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Scatter Bubble Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        #chart {
            padding-left: 20px;
            padding-top: 120px;
            width: 800px;
            /* Or whatever width you want */
            margin: 0 auto;
            /* Center horizontally */
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .legend {
            position: absolute;
            top: 20px;
            /* Position at the top */
            left: 20px;
            /* Position on the left (or adjust as needed) */
            display: flex;
            flex-wrap: wrap;
            /* Allow wrapping */
            /* overflow-y: auto; */
            /* max-height: 60px; */
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 10px;
            /* Space between legend items */
            cursor: pointer;
        }

        .legend-item.active {
            opacity: 0.7;
        }

        .legend-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        /* Media query for smaller screens */
        @media (max-width: 600px) {

            /* Adjust breakpoint as needed */
            .legend {
                flex-direction: column;
                /* Stack legend items vertically */
                max-height: 100px;
                /* Adjust maximum height as needed */
                overflow-y: auto;
                /* Make it scrollable */
            }

            .legend-item {
                margin-right: 10px;
                /* Reduce right margin */
            }

            #chart {
                padding-left: 20px;
                padding-top: 140px;
            }
        }

        /* Basic toast styling */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .toast.show {
            opacity: 1;
        }

        #chart svg { /* Target the SVG inside #chart */
            width: 100%; /* Make SVG responsive */
            height: auto; /* Maintain aspect ratio */
        }

        /* Media query for smaller screens */
        @media (max-width: 600px) { /* Adjust breakpoint as needed */
            #chart svg {
                width: 100%; /* Occupy full width */
                height: auto; /* Maintain aspect ratio */
            }
        }
    </style>
</head>

<body>

    <div id="chart"></div>
    <div class="legend"></div>
    <div id="toast" class="toast"></div>

    <script>
        const margin = { top: 20, right: 150, bottom: 20, left: 20 }; // Adjusted right margin for legend
        const width = 800 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;

        const svg = d3.select("#chart").append("svg")
        .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`) // Set viewBox
        .attr("preserveAspectRatio", "xMidYMid meet") // Preserve aspect ratio and fit
        .attr("width", "100%") // Make the SVG responsive
        .attr("height", "auto")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const color = d3.scaleOrdinal(d3.schemePastel1);


        const apiUrlPoints = "https://indb-embedding.cfapps.eu12.hana.ondemand.com/get_clusters";
        const apiUrlDescriptions = "https://indb-embedding.cfapps.eu12.hana.ondemand.com/get_clusters_description";

        Promise.all([d3.json(apiUrlPoints), d3.json(apiUrlDescriptions)])
            .then(([pointsData, descriptionsData]) => {
                const descriptionMap = new Map();
                descriptionsData.forEach(d => {
                    descriptionMap.set(d.CLUSTER_ID, d.CLUSTER_DESCRIPTION);
                });

                const processedPointsData = pointsData.map(point => ({
                    ...point,
                    CLUSTER_DESCRIPTION: descriptionMap.get(point.CLUSTER_ID) || "Unknown Cluster"
                }));


                const x = d3.scaleLinear()
                    .domain(d3.extent(processedPointsData, d => +d.x))
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain(d3.extent(processedPointsData, d => +d.y))
                    .range([height, 0]);

                const radius = d3.scaleSqrt()
                    .domain([0, d3.max(processedPointsData, d => 10)])
                    .range([3, 15]);

                let circles = svg.selectAll("circle")
                    .data(processedPointsData)
                    .enter().append("circle")
                    .attr("cx", d => x(d.x))
                    .attr("cy", d => y(d.y))
                    .attr("r", 0)
                    .attr("fill", d => color(d.CLUSTER_ID))
                    .on("mouseover", function (event, d) {
                        d3.select(".tooltip")
                            .transition().duration(200).style("opacity", .9);
                        d3.select(".tooltip")
                            .html(`Project Number: ${d.PROJECT_NUMBER}<br>X: ${d.x}<br>Y: ${d.y}<br>Cluster: ${d.CLUSTER_DESCRIPTION}`)
                            .style("left", (event.pageX) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (d) {
                        d3.select(".tooltip").transition().duration(500).style("opacity", 0);
                    })
                    .on("click", function (event, d) {
                        // alert();
                        showBubbleDetails(d);
                        // Show toast message
                        // showToast(`Project Number: ${d.PROJECT_NUMBER}<br>X: ${d.x}<br>Y: ${d.y}<br>Cluster: ${d.CLUSTER_DESCRIPTION}`);
                        showToast(`Project Number: ${d.PROJECT_NUMBER}<br>Cluster: ${d.CLUSTER_DESCRIPTION}`);
                    })
                    .transition().duration(500).attr("r", d => radius(10));


                d3.select("body").append("div").attr("class", "tooltip");

                // Create the axes WITH scales
                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).tickFormat("")); // x-axis

                svg.append("g")
                    .call(d3.axisLeft(y).tickFormat(""));    // y-axis

                const clusters = [...new Set(processedPointsData.map(d => d.CLUSTER_ID))].sort();

                const legend = d3.select(".legend")
                    .selectAll(".legend-item")
                    .data(clusters)
                    .enter().append("div")
                    .attr("class", "legend-item")
                    .on("click", function (event, cluster) {
                        const legendItem = d3.select(this);
                        legendItem.classed("active", !legendItem.classed("active"));

                        const selectedClusters = d3.selectAll(".legend-item.active").data();

                        svg.selectAll("circle")
                            .transition().duration(300)
                            .style("opacity", d => {
                                if (selectedClusters.length === 0) {
                                    return 1; // Show all if no clusters are selected
                                } else {
                                    return selectedClusters.includes(d.CLUSTER_ID) ? 1 : 0; // Filter based on selected clusters
                                }
                            });


                    });

                legend.append("div")
                    .attr("class", "legend-circle")
                    .style("background-color", d => color(d));

                legend.append("span")
                    .text(cluster => descriptionMap.get(cluster) || "Unknown Cluster");

            })
            .catch(error => {
                console.error("Error loading data:", error);
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .text("Error loading data. Please try again later.");
            });


        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerHTML = message;
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
            }, 3000); // Hide after 3 seconds
        }

        // Function to handle bubble click event
        function showBubbleDetails(data) {
            // Access the data properties like this:
            const projectNumber = data.PROJECT_NUMBER;
            const xValue = data.x;
            const yValue = data.y;
            const clusterDescription = data.CLUSTER_DESCRIPTION;

            // Here you can do whatever you want with the data:
            // 1. Alert:
            // alert(`Project Number: ${projectNumber}\nX: ${xValue}\nY: ${yValue}\nCluster: ${clusterDescription}`);

            // 2. Toast message (if you're using the toast):
            showToast(`Project Number: ${projectNumber}<br>X: ${xValue}<br>Y: ${yValue}<br>Cluster: ${clusterDescription}`);

            // 3. Open a new window/tab:
            // window.open(`details.html?id=${projectNumber}`, '_blank'); // Example

            // 4. Update a div on the page:
            // document.getElementById("details").innerHTML = `Project Number: ${projectNumber} ...`;

            // 5. Or any other action you want to perform.
            console.log("Clicked Bubble Data:", data); // Check the console
        }

    </script>

</body>

</html>